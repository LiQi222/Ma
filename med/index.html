<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>家庭药品管理系统 (LeanCloud版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- LeanCloud SDK -->
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.13/dist/av-live-query-min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', 'Microsoft YaHei', sans-serif; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .modal-backdrop { background-color: rgba(0,0,0,0.5); }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- 应用加载动画 -->
    <div id="app-loader" class="fixed inset-0 z-50 flex items-center justify-center bg-gray-100">
        <svg class="animate-spin h-10 w-10 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
    </div>

    <!-- 主容器 -->
    <div id="app" class="container mx-auto p-4 max-w-4xl">
        <!-- 登录/注册界面 (默认隐藏) -->
        <div id="auth-container" class="max-w-md mx-auto my-12 hidden">
            <div class="bg-white p-8 rounded-xl shadow-lg">
                <h1 class="text-3xl font-bold text-center text-blue-600 mb-2">家庭药品管理系统</h1>
                <p class="text-center text-gray-500 mb-8">请登录或注册以继续 (LeanCloud版)</p>
                <div id="auth-content">
                    <!-- 登录表单 -->
                    <form id="login-form" class="space-y-4">
                        <h2 class="text-xl font-semibold text-center">登录</h2>
                        <div>
                            <label for="login-username" class="block text-sm font-medium text-gray-700">用户名</label>
                            <input type="text" id="login-username" required autocomplete="username" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="login-password" class="block text-sm font-medium text-gray-700">密码</label>
                            <input type="password" id="login-password" required autocomplete="current-password" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <p id="login-error" class="text-red-500 text-sm"></p>
                        <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">登录</button>
                        <p class="text-center text-sm">还没有账户? <a href="#" id="show-register" class="font-medium text-blue-600 hover:text-blue-500">立即注册</a></p>
                    </form>
                    <!-- 注册表单 (默认隐藏) -->
                    <form id="register-form" class="space-y-4 hidden">
                        <h2 class="text-xl font-semibold text-center">注册</h2>
                        <div>
                            <label for="register-username" class="block text-sm font-medium text-gray-700">用户名</label>
                            <input type="text" id="register-username" required autocomplete="username" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="register-password" class="block text-sm font-medium text-gray-700">密码 (至少6位)</label>
                            <input type="password" id="register-password" required autocomplete="new-password" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <p id="register-error" class="text-red-500 text-sm"></p>
                        <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">注册</button>
                        <p class="text-center text-sm">已有账户? <a href="#" id="show-login" class="font-medium text-blue-600 hover:text-blue-500">返回登录</a></p>
                    </form>
                </div>
            </div>
        </div>
        <!-- 药品管理主界面 (默认隐藏) -->
        <div id="main-app" class="hidden">
             <header class="flex flex-col sm:flex-row justify-between items-center mb-6 bg-white p-4 rounded-xl shadow-md gap-4">
                 <div class="flex-grow">
                     <h1 class="text-2xl font-bold text-blue-600">我的药箱</h1>
                     <p id="user-display" class="text-sm text-gray-500"></p>
                 </div>
                 <div class="flex items-center gap-2">
                     <button id="manage-members-btn" class="text-sm bg-gray-200 text-gray-800 px-3 py-2 rounded-lg hover:bg-gray-300 transition">管理成员</button>
                     <button id="logout-btn" class="text-sm bg-red-500 text-white px-3 py-2 rounded-lg hover:bg-red-600 transition">退出登录</button>
                 </div>
             </header>
             <div class="mb-6 flex flex-col sm:flex-row gap-4 items-center">
                 <button id="add-medicine-btn" class="w-full sm:w-auto bg-blue-600 text-white px-5 py-2 rounded-lg hover:bg-blue-700 transition shadow-md flex-shrink-0">+ 添加新药品</button>
                 <button id="check-expiry-btn" class="w-full sm:w-auto bg-yellow-500 text-white px-5 py-2 rounded-lg hover:bg-yellow-600 transition shadow-md flex-shrink-0">! 检查过期药品</button>
                 <div class="w-full flex-grow">
                     <select id="member-filter" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                         <option value="all">所有成员</option>
                     </select>
                 </div>
             </div>
             <p id="loading-medicines" class="flex items-center justify-center text-center text-gray-500 mt-10">
                 <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                     <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                     <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                 </svg>
                 正在加载药品...
             </p>
             <div id="medicines-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
             <p id="no-medicines" class="hidden text-center text-gray-500 mt-10 p-6 bg-white rounded-lg shadow">您的药箱是空的，点击 "添加新药品" 来开始管理吧！</p>
        </div>
    </div>
    <!-- 模态框等 -->
    <div id="medicine-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop">
        <div class="bg-white rounded-xl shadow-2xl p-8 m-4 max-w-lg w-full transform transition-all duration-300 scale-95 opacity-0" id="medicine-modal-content">
            <h2 id="modal-title" class="text-2xl font-bold mb-6">添加新药品</h2>
            <form id="medicine-form">
                <input type="hidden" id="medicine-id">
                <div class="space-y-4">
                    <div>
                        <label for="name" class="block text-sm font-medium text-gray-700">药品名称</label>
                        <input type="text" id="name" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="member" class="block text-sm font-medium text-gray-700">所属成员</label>
                        <select id="member" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"><option value="通用">通用</option></select>
                    </div>
                    <div>
                        <label for="indication" class="block text-sm font-medium text-gray-700">作用/功能</label>
                        <textarea id="indication" rows="2" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">用法用量</label>
                        <div class="mt-1 grid grid-cols-1 sm:grid-cols-3 gap-2 items-center text-sm">
                            <div class="flex items-center gap-1">
                                <span>1天</span>
                                <select id="usage-freq" class="w-full px-2 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option></select>
                                <span>次,</span>
                            </div>
                            <div class="flex items-center gap-1">
                                <span>每次</span>
                                <input type="number" id="usage-dose" placeholder="数字" required class="w-full px-2 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                <select id="usage-dose-unit" class="w-full px-2 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"><option>片</option><option>粒</option><option>袋</option></select>
                                <span>,</span>
                            </div>
                            <select id="usage-rule" class="w-full px-2 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"><option>饭后服用</option><option>饭前服用</option><option>无</option></select>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="expiry" class="block text-sm font-medium text-gray-700">到期时间</label>
                            <input type="date" id="expiry" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="quantity-amount" class="block text-sm font-medium text-gray-700">数量/余量</label>
                            <div class="mt-1 flex gap-2">
                                <input type="number" id="quantity-amount" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="数量">
                                <select id="quantity-unit" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"><option>片</option><option>粒</option><option>袋</option></select>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-8 flex justify-end space-x-3">
                    <button type="button" id="cancel-btn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300 transition">取消</button>
                    <button type="submit" id="save-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">保存</button>
                </div>
            </form>
        </div>
    </div>
    <div id="member-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop">
        <div class="bg-white rounded-xl shadow-2xl p-8 m-4 max-w-md w-full transform transition-all duration-300 scale-95 opacity-0" id="member-modal-content">
            <h2 class="text-2xl font-bold mb-6">管理家庭成员</h2>
            <form id="add-member-form" class="flex gap-2 mb-4">
                <input type="text" id="new-member-name" placeholder="输入新成员名称" required class="flex-grow px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">添加</button>
            </form>
            <div id="members-list" class="space-y-2 max-h-60 overflow-y-auto"></div>
            <div class="mt-8 text-right">
                <button type="button" id="close-member-modal-btn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300 transition">关闭</button>
            </div>
        </div>
    </div>
    <div id="expiry-check-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop">
        <div class="bg-white rounded-xl shadow-2xl p-8 m-4 max-w-lg w-full max-h-[80vh] flex flex-col transform transition-all duration-300 scale-95 opacity-0" id="expiry-modal-content">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">过期药品检查</h2>
            <div class="overflow-y-auto pr-2 flex-grow">
                <h3 class="text-lg font-semibold mb-2 text-red-600">一周内过期或已过期</h3>
                <div id="expiry-list-7-days" class="mb-4"></div>
                <h3 class="text-lg font-semibold mb-2 text-yellow-600">一个月内过期</h3>
                <div id="expiry-list-30-days"></div>
            </div>
            <div class="mt-6 text-right">
                <button id="close-expiry-modal-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">关闭</button>
            </div>
        </div>
    </div>
    <div id="confirm-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop">
        <div class="bg-white rounded-xl shadow-2xl p-8 m-4 max-w-sm w-full transform transition-all duration-300 scale-95 opacity-0" id="confirm-modal-content">
            <h3 id="confirm-modal-title" class="text-lg font-medium leading-6 text-gray-900">确认操作</h3>
            <div class="mt-2"><p id="confirm-modal-text" class="text-sm text-gray-500">您确定要继续吗？</p></div>
            <div class="mt-5 sm:mt-6 sm:grid sm:grid-cols-2 sm:gap-3 sm:grid-flow-row-dense">
                <button id="confirm-modal-yes" type="button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none sm:col-start-2 sm:text-sm">确认</button>
                <button id="confirm-modal-no" type="button" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:mt-0 sm:col-start-1 sm:text-sm">取消</button>
            </div>
        </div>
    </div>
    <div id="toast-notification" class="fixed bottom-5 right-5 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-50">
        <p id="toast-message"></p>
    </div>

    <script>
    // 使用 load 事件确保所有资源加载完毕
    window.addEventListener('load', () => { 
        // --- 全局变量和 LeanCloud 配置 ---
        const leanCloudConfig = {
            appId: "lcuyFylpc6ZdrlT7MqG39HO4-gzGzoHsz",
            appKey: "ZVlwqrv2fexZs506aLB6S2he",
            serverURL: "https://lcuyfylp.lc-cn-n1-shared.com"
        };

        // LeanCloud Class
        const Medication = AV.Object.extend('Medication');
        const Member = AV.Object.extend('Member');

        let app;
        let currentMedicines = [];
        let currentMembers = [];
        let liveQueryMed = null;
        let liveQueryMember = null;
        
        // --- UI 元素 ---
        const appLoader = document.getElementById('app-loader');
        const authContainer = document.getElementById('auth-container');
        const mainApp = document.getElementById('main-app');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const showRegisterLink = document.getElementById('show-register');
        const showLoginLink = document.getElementById('show-login');
        const logoutBtn = document.getElementById('logout-btn');
        const userDisplay = document.getElementById('user-display');
        const medicinesList = document.getElementById('medicines-list');
        const loadingMedicines = document.getElementById('loading-medicines');
        const noMedicines = document.getElementById('no-medicines');
        const medicineModal = document.getElementById('medicine-modal');
        const medicineModalContent = document.getElementById('medicine-modal-content');
        const medicineForm = document.getElementById('medicine-form');
        const modalTitle = document.getElementById('modal-title');
        const addMedicineBtn = document.getElementById('add-medicine-btn');
        const cancelBtn = document.getElementById('cancel-btn');
        const checkExpiryBtn = document.getElementById('check-expiry-btn');
        const expiryCheckModal = document.getElementById('expiry-check-modal');
        const expiryModalContent = document.getElementById('expiry-modal-content');
        const expiryList7Days = document.getElementById('expiry-list-7-days');
        const expiryList30Days = document.getElementById('expiry-list-30-days');
        const closeExpiryModalBtn = document.getElementById('close-expiry-modal-btn');
        const confirmModal = document.getElementById('confirm-modal');
        const confirmModalContent = document.getElementById('confirm-modal-content');
        const manageMembersBtn = document.getElementById('manage-members-btn');
        const memberModal = document.getElementById('member-modal');
        const memberModalContent = document.getElementById('member-modal-content');
        const closeMemberModalBtn = document.getElementById('close-member-modal-btn');
        const addMemberForm = document.getElementById('add-member-form');
        const membersListEl = document.getElementById('members-list');
        const memberSelect = document.getElementById('member');
        const memberFilter = document.getElementById('member-filter');
        const toastEl = document.getElementById('toast-notification');
        const toastMessageEl = document.getElementById('toast-message');

        // --- 初始化 LeanCloud ---
        function initializeLeanCloud() {
            try {
                if (!window.AV) {
                    throw new Error("LeanCloud SDK 未能成功加载。");
                }
                AV.init(leanCloudConfig);
                setupAuthListener();
            } catch (err) {
                console.error("LeanCloud 初始化失败:", err);
                appLoader.classList.add('hidden');
                authContainer.classList.remove('hidden');
                const loginError = document.getElementById('login-error');
                if (loginError) {
                    loginError.textContent = "无法连接到云服务：" + err.message;
                }
            }
        }

        // --- 认证状态监听 ---
        async function setupAuthListener() {
            const currentUser = AV.User.current();
            if (currentUser) {
                userDisplay.textContent = `欢迎, ${currentUser.get('username')}`;
                mainApp.classList.remove('hidden');
                authContainer.classList.add('hidden');
                await fetchInitialData();
                await setupLiveQueries();
            } else {
                if(liveQueryMed) liveQueryMed.unsubscribe();
                if(liveQueryMember) liveQueryMember.unsubscribe();
                mainApp.classList.add('hidden');
                authContainer.classList.remove('hidden');
            }
            appLoader.classList.add('hidden');
        }

        // --- 认证功能 ---
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('login-username').value.trim();
            const password = document.getElementById('login-password').value;
            const errorP = document.getElementById('login-error');
            errorP.textContent = '';
            try {
                await AV.User.logIn(username, password);
                await setupAuthListener();
            } catch (err) {
                console.error("登录失败:", err);
                errorP.textContent = "用户名或密码错误。";
            }
        });

        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('register-username').value.trim();
            const password = document.getElementById('register-password').value;
            const errorP = document.getElementById('register-error');
            errorP.textContent = '';
            
            const user = new AV.User();
            user.setUsername(username);
            user.setPassword(password);

            try {
                await user.signUp();
                showToast("注册成功！已自动登录。");
                await setupAuthListener();
            } catch (err) {
                console.error("注册失败:", err);
                if (err.code === 202) {
                    errorP.textContent = "此用户名已被使用。";
                } else {
                    errorP.textContent = "注册失败，请稍后重试。";
                }
            }
        });

        logoutBtn.addEventListener('click', async () => {
            await AV.User.logOut();
            await setupAuthListener();
        });

        showRegisterLink.addEventListener('click', (e) => { e.preventDefault(); loginForm.classList.add('hidden'); registerForm.classList.remove('hidden'); });
        showLoginLink.addEventListener('click', (e) => { e.preventDefault(); registerForm.classList.add('hidden'); loginForm.classList.remove('hidden'); });
        
        // --- LiveQuery (实时同步) ---
        async function setupLiveQueries() {
            try {
                const currentUser = AV.User.current();
                if (!currentUser) return;

                // --- 药品实时监听 ---
                const medQuery = new AV.Query('Medication');
                medQuery.equalTo('owner', currentUser);
                if(liveQueryMed) await liveQueryMed.unsubscribe();
                liveQueryMed = await medQuery.subscribe();

                liveQueryMed.on('create', (data) => handleDataChange(data, 'create', 'medication'));
                liveQueryMed.on('update', (data) => handleDataChange(data, 'update', 'medication'));
                liveQueryMed.on('delete', (data) => handleDataChange(data, 'delete', 'medication'));
                
                // --- 成员实时监听 ---
                const memberQuery = new AV.Query('Member');
                memberQuery.equalTo('owner', currentUser);
                if(liveQueryMember) await liveQueryMember.unsubscribe();
                liveQueryMember = await memberQuery.subscribe();

                liveQueryMember.on('create', (data) => handleDataChange(data, 'create', 'member'));
                liveQueryMember.on('update', (data) => handleDataChange(data, 'update', 'member'));
                liveQueryMember.on('delete', (data) => handleDataChange(data, 'delete', 'member'));

                console.log("实时数据同步已开启");

            } catch(error) {
                console.error("开启实时同步失败:", error);
                showToast("实时同步连接失败，部分数据可能不会自动刷新。", 5000, true);
            }
        }
        
        // [已修复] 统一的实时数据处理函数
        function handleDataChange(data, event, type) {
            console.log(`LiveQuery event: ${event} on ${type}`, data.id, data.attributes);
            const dataArray = type === 'medication' ? currentMedicines : currentMembers;
            const changedItem = { id: data.id, ...data.attributes };
            const index = dataArray.findIndex(item => item.id === changedItem.id);

            if (event === 'create' && index === -1) {
                dataArray.push(changedItem);
            } else if (event === 'update' && index > -1) {
                dataArray[index] = changedItem;
            } else if (event === 'delete' && index > -1) {
                dataArray.splice(index, 1);
            }
            
            // 重新渲染对应UI
            if (type === 'medication') {
                currentMedicines.sort((a, b) => (a.name || "").localeCompare(b.name || ""));
                filterAndRenderMedicines();
            } else {
                currentMembers.sort((a, b) => (a.name || "").localeCompare(b.name || ""));
                renderMembers();
                populateMemberDropdowns();
            }
        }
        
        async function fetchInitialData() {
            loadingMedicines.classList.remove('hidden');
            noMedicines.classList.add('hidden');
            medicinesList.innerHTML = '';
            
            const currentUser = AV.User.current();
            if (!currentUser) return;

            const medQuery = new AV.Query('Medication');
            medQuery.equalTo('owner', currentUser);
            const memberQuery = new AV.Query('Member');
            memberQuery.equalTo('owner', currentUser);
            
            try {
                const [meds, members] = await Promise.all([medQuery.find(), memberQuery.find()]);
                currentMedicines = meds.map(m => ({ id: m.id, ...m.attributes })).sort((a,b) => (a.name || "").localeCompare(b.name || ""));
                currentMembers = members.map(m => ({ id: m.id, ...m.attributes })).sort((a,b) => (a.name || "").localeCompare(b.name || ""));
                
                renderMembers();
                populateMemberDropdowns();
                filterAndRenderMedicines();

            } catch (error) {
                console.error("获取初始数据失败:", error);
                loadingMedicines.textContent = "数据加载失败，请刷新重试。";
            } finally {
                loadingMedicines.classList.add('hidden');
            }
        }

        // --- 家庭成员管理 ---
        function renderMembers() {
             membersListEl.innerHTML = '';
            currentMembers.forEach(member => {
                const item = document.createElement('div');
                item.className = 'flex justify-between items-center bg-gray-100 p-2 rounded';
                item.innerHTML = `
                    <span>${member.name}</span>
                    <button class="delete-member-btn text-red-500 hover:text-red-700" data-id="${member.id}">&times;</button>
                `;
                membersListEl.appendChild(item);
            });
        }
        function populateMemberDropdowns() {
            const optionsHtml = currentMembers.map(m => `<option value="${m.name}">${m.name}</option>`).join('');
            memberSelect.innerHTML = `<option value="通用">通用</option>${optionsHtml}`;
            memberFilter.innerHTML = `<option value="all">所有成员</option><option value="通用">通用</option>${optionsHtml}`;
        }
        addMemberForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const newMemberName = document.getElementById('new-member-name').value.trim();
            if (newMemberName) {
                const member = new Member();
                member.set('name', newMemberName);
                member.set('owner', AV.User.current());
                try {
                    await member.save();
                    addMemberForm.reset();
                } catch(error){
                    console.error("添加成员失败:", error);
                    showToast("添加成员失败", 3000, true);
                }
            }
        });
        membersListEl.addEventListener('click', async (e) => {
            if (e.target.classList.contains('delete-member-btn')) {
                const id = e.target.dataset.id;
                const confirmed = await showConfirm("确认删除", "删除成员会影响关联的药品信息，确定吗？");
                if(confirmed) {
                    const member = AV.Object.createWithoutData('Member', id);
                    try {
                        await member.destroy();
                    } catch(error) {
                        console.error("删除成员失败:", error);
                        showToast("删除成员失败", 3000, true);
                    }
                }
            }
        });
        manageMembersBtn.addEventListener('click', () => {
            memberModal.classList.remove('hidden');
            setTimeout(() => memberModalContent.classList.remove('scale-95', 'opacity-0'), 10);
        });
        closeMemberModalBtn.addEventListener('click', () => {
             memberModalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => memberModal.classList.add('hidden'), 300);
        });

        // --- 药品数据处理 ---
        memberFilter.addEventListener('change', filterAndRenderMedicines);
        function filterAndRenderMedicines() {
            const selectedMember = memberFilter.value;
            const filteredMeds = selectedMember === 'all'
                ? currentMedicines
                : currentMedicines.filter(med => med.member === selectedMember);
            renderMedicines(filteredMeds);
        }

        function getExpiryStatus(expiryDate) {
            if (!expiryDate) return { status: 'ok', text: '未设置', days: Infinity };
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const expiry = new Date(expiryDate);
            expiry.setHours(0,0,0,0);
            const diffTime = expiry - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            if (diffDays < 0) return { status: 'expired', text: `已过期 ${-diffDays} 天`, days: diffDays };
            if (diffDays <= 7) return { status: 'expiring-soon-7', text: `剩余 ${diffDays} 天`, days: diffDays };
            if (diffDays <= 30) return { status: 'expiring-soon-30', text: `剩余 ${diffDays} 天过期`, days: diffDays };
            return { status: 'ok', text: `剩余 ${diffDays} 天`, days: diffDays };
        }

        function renderMedicines(medicines) {
            medicinesList.innerHTML = '';
            noMedicines.classList.toggle('hidden', medicines.length > 0);
            
            medicines.forEach(med => {
                const { status, text } = getExpiryStatus(med.expiry);
                let borderColor = 'border-gray-200', textColor = 'text-gray-500';
                if (status === 'expired') { borderColor = 'border-red-500'; textColor = 'text-red-500'; } 
                else if (status === 'expiring-soon-7') { borderColor = 'border-red-500'; textColor = 'text-red-600'; } 
                else if (status === 'expiring-soon-30') { borderColor = 'border-yellow-500'; textColor = 'text-yellow-600'; }
                
                const card = document.createElement('div');
                card.className = `bg-white p-5 rounded-xl shadow-md border-l-4 ${borderColor} transition-transform hover:scale-105 hover:shadow-lg flex flex-col`;
                card.innerHTML = `
                    <div class="flex-grow">
                        <div class="flex justify-between items-start">
                            <h3 class="text-xl font-bold text-gray-900">${med.name}</h3>
                            <div class="text-sm font-semibold ${textColor}">${text}</div>
                        </div>
                        <p class="text-sm text-gray-500 mb-2"><strong>成员:</strong> ${med.member || '通用'}</p>
                        <p class="text-gray-600 mt-2 mb-1"><strong>作用:</strong> ${med.indication}</p>
                        <p class="text-gray-600 mb-1"><strong>用法:</strong> ${med.usage || '未指定'}</p>
                        <p class="text-gray-600 mb-3"><strong>余量:</strong> ${med.quantity}</p>
                        <p class="text-xs text-gray-400 mb-2"><strong>到期日:</strong> ${med.expiry}</p>
                        <p class="text-xs text-gray-400"><strong>上次服用:</strong> ${med.lastTaken ? new Date(med.lastTaken).toLocaleString('zh-CN') : '无记录'}</p>
                    </div>
                    <div class="flex justify-end space-x-2 border-t pt-3 mt-3">
                        <button class="log-dose-btn text-sm bg-green-100 text-green-800 px-3 py-1 rounded-md hover:bg-green-200" data-id="${med.id}">我已服用</button>
                        <button class="edit-btn text-sm bg-blue-100 text-blue-800 px-3 py-1 rounded-md hover:bg-blue-200" data-id="${med.id}">编辑</button>
                        <button class="delete-btn text-sm bg-red-100 text-red-800 px-3 py-1 rounded-md hover:bg-red-200" data-id="${med.id}">删除</button>
                    </div>`;
                medicinesList.appendChild(card);
            });
        }
        
        // --- 模态框控制 ---
        function openModal(mode = 'add', medicine = null) {
            medicineForm.reset();
            populateMemberDropdowns();
            document.getElementById('medicine-id').value = '';
            if (mode === 'edit' && medicine) {
                modalTitle.textContent = '编辑药品';
                document.getElementById('medicine-id').value = medicine.id;
                document.getElementById('name').value = medicine.name;
                document.getElementById('indication').value = medicine.indication;
                document.getElementById('expiry').value = medicine.expiry;
                document.getElementById('member').value = medicine.member || '通用';
                const quantMatch = medicine.quantity ? medicine.quantity.match(/^(\d+)\s*(.*)$/) : null;
                if (quantMatch) {
                    document.getElementById('quantity-amount').value = quantMatch[1];
                    document.getElementById('quantity-unit').value = quantMatch[2] || '片';
                } else { document.getElementById('quantity-amount').value = medicine.quantity; }
                const usage = medicine.usage || '';
                const freqMatch = usage.match(/1天(\d+)次/);
                const doseMatch = usage.match(/每次(\d+)\s*(片|粒|袋)/);
                const ruleMatch = usage.match(/(饭后服用|饭前服用|无)/);
                if(freqMatch) document.getElementById('usage-freq').value = freqMatch[1];
                if(doseMatch) {
                    document.getElementById('usage-dose').value = doseMatch[1];
                    document.getElementById('usage-dose-unit').value = doseMatch[2];
                }
                if(ruleMatch) document.getElementById('usage-rule').value = ruleMatch[1];
            } else { modalTitle.textContent = '添加新药品'; }
            medicineModal.classList.remove('hidden');
            setTimeout(() => medicineModalContent.classList.remove('scale-95', 'opacity-0'), 10);
        }
        function closeModal() {
            medicineModalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => { medicineModal.classList.add('hidden'); }, 300);
        }
        addMedicineBtn.addEventListener('click', () => openModal('add'));
        cancelBtn.addEventListener('click', closeModal);
        
        // --- 表单提交 ---
        medicineForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('medicine-id').value;
            const usageString = `1天${document.getElementById('usage-freq').value}次, 每次${document.getElementById('usage-dose').value}${document.getElementById('usage-dose-unit').value}, ${document.getElementById('usage-rule').value}`;
            const quantityString = `${document.getElementById('quantity-amount').value}${document.getElementById('quantity-unit').value}`;
            
            const medication = id ? AV.Object.createWithoutData('Medication', id) : new Medication();
            
            medication.set('name', document.getElementById('name').value);
            medication.set('indication', document.getElementById('indication').value);
            medication.set('expiry', document.getElementById('expiry').value);
            medication.set('quantity', quantityString);
            medication.set('usage', usageString);
            medication.set('member', document.getElementById('member').value);
            
            if (!id) {
                medication.set('lastTaken', null);
                medication.set('owner', AV.User.current());
            }
            
            try {
                await medication.save();
                closeModal();
            } catch (error) { 
                console.error("保存药品失败:", error); 
                showToast("保存药品失败", 3000, true);
            }
        });

        // --- 事件代理 ---
        medicinesList.addEventListener('click', async (e) => {
            const target = e.target;
            const id = target.dataset.id;
            if (!id) return;

            if (target.classList.contains('edit-btn')) {
                const medicineToEdit = currentMedicines.find(med => med.id === id);
                if (medicineToEdit) openModal('edit', medicineToEdit);
            }
            if (target.classList.contains('delete-btn')) {
                const confirmed = await showConfirm('确认删除', '您确定要删除这个药品吗？');
                if (confirmed) {
                    const medication = AV.Object.createWithoutData('Medication', id);
                    try {
                        await medication.destroy();
                    } catch(error) {
                        console.error("删除药品失败", error);
                        showToast("删除药品失败", 3000, true);
                    }
                }
            }
            if (target.classList.contains('log-dose-btn')) { 
                await logDose(id); 
            }
        });
        
        // [已修复] `我已服用`按钮功能
        async function logDose(id) {
            try {
                // [已修复] 直接从服务器获取最新的药品对象，避免使用可能过期的本地数据
                const medication = AV.Object.createWithoutData('Medication', id);
                await medication.fetch();

                const currentUsage = medication.get('usage');
                const currentQuantityStr = medication.get('quantity');

                // 检查用量和库存信息是否存在
                if (currentUsage && currentQuantityStr) {
                    const doseMatch = currentUsage.match(/每次(\d+)/);
                    const quantMatch = currentQuantityStr.match(/^(\d+)/);

                    if (doseMatch && quantMatch) {
                        const doseToSubtract = parseInt(doseMatch[1], 10);
                        const currentQuantityNum = parseInt(quantMatch[0], 10);

                        if (currentQuantityNum < doseToSubtract) {
                            showToast("药品不足，请及时购买！", 3000, true);
                            return; // 中止操作
                        }

                        const newQuantity = Math.max(0, currentQuantityNum - doseToSubtract);
                        // [已修复] 使用正则表达式安全地替换数字部分
                        const newQuantityStr = currentQuantityStr.replace(/^\d+/, newQuantity);
                        medication.set('quantity', newQuantityStr);
                    }
                }

                // 更新上次服药时间
                medication.set('lastTaken', new Date());

                // 保存更新到服务器
                await medication.save();
                showToast('服药记录已更新！');

            } catch (error) {
                // [已优化] 提供更详细的错误日志
                console.error("记录服药失败: ", {
                    error: error,
                    medicineId: id
                });
                showToast(`记录服药失败: ${error.message || '未知错误'}`, 4000, true);
            }
        }
        
        // --- 检查过期 ---
        checkExpiryBtn.addEventListener('click', () => {
            const allMedsWithStatus = currentMedicines.map(med => ({ ...med, statusInfo: getExpiryStatus(med.expiry) }));
            const expiringIn7Days = allMedsWithStatus.filter(med => med.statusInfo.days <= 7).sort((a, b) => a.statusInfo.days - b.statusInfo.days);
            const expiringIn30Days = allMedsWithStatus.filter(med => med.statusInfo.days > 7 && med.statusInfo.days <= 30).sort((a, b) => a.statusInfo.days - b.statusInfo.days);
            
            renderExpiryLists(expiringIn7Days, expiringIn30Days);
            
            expiryCheckModal.classList.remove('hidden');
            setTimeout(() => { expiryModalContent.classList.remove('scale-95', 'opacity-0'); }, 10);
        });
        function renderExpiryLists(list7Days, list30Days) {
             const renderList = (container, medicines) => {
                 container.innerHTML = '';
                 if (medicines.length === 0) {
                     container.innerHTML = '<p class="text-sm text-gray-500">此范围内没有药品。</p>';
                     return;
                 }
                 medicines.forEach(med => {
                     const { status, text } = med.statusInfo;
                     let textColor = 'text-gray-600';
                     if (status === 'expired') textColor = 'text-red-500 font-bold';
                     else if (status === 'expiring-soon-7') textColor = 'text-red-600 font-semibold';
                     else if (status === 'expiring-soon-30') textColor = 'text-yellow-600 font-semibold';
                     const item = document.createElement('div');
                     item.className = 'py-3 border-b last:border-b-0';
                     item.innerHTML = `<div class="flex justify-between items-center"><span class="font-medium text-gray-800">${med.name}</span><span class="text-sm ${textColor}">${text}</span></div>`;
                     container.appendChild(item);
                 });
             };
             renderList(expiryList7Days, list7Days);
             renderList(expiryList30Days, list30Days);
        }
        closeExpiryModalBtn.addEventListener('click', () => {
            expiryModalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => { expiryCheckModal.classList.add('hidden');}, 300);
        });

        // --- Toast & Confirm ---
        let toastTimeout;
        function showToast(message, duration = 3000, isError = false) {
            toastMessageEl.textContent = message;
            toastEl.classList.toggle('bg-red-500', isError);
            toastEl.classList.toggle('bg-green-500', !isError);
            toastEl.classList.remove('translate-y-20', 'opacity-0');
            clearTimeout(toastTimeout);
            toastTimeout = setTimeout(() => {
                toastEl.classList.add('translate-y-20', 'opacity-0');
            }, duration);
        }
        function showConfirm(title, text) {
            return new Promise((resolve) => {
                document.getElementById('confirm-modal-title').textContent = title;
                document.getElementById('confirm-modal-text').textContent = text;
                const yesBtn = document.getElementById('confirm-modal-yes');
                const noBtn = document.getElementById('confirm-modal-no');
                
                const close = (value) => {
                    confirmModalContent.classList.add('scale-95', 'opacity-0');
                    setTimeout(() => { confirmModal.classList.add('hidden'); }, 300);
                    yesBtn.onclick = null;
                    noBtn.onclick = null;
                    resolve(value);
                };
                
                yesBtn.onclick = () => close(true);
                noBtn.onclick = () => close(false);
                
                confirmModal.classList.remove('hidden');
                setTimeout(() => { confirmModalContent.classList.remove('scale-95', 'opacity-0'); }, 10);
            });
        }

        // --- 应用启动 ---
        initializeLeanCloud();
    });
    </script>
</body>
</html>
